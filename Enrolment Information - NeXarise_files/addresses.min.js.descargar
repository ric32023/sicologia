define(["jquery","app","pubsub","ajax","bootstrap"],function(n,t,i,r){var u={bind:function(i){var r=n(i);n("[data-region-bind]",r).on("change",function(i,r){if(!r||!r._init){var f=n(this),o=f.val(),u=f.data("region-bind"),e=n(u.contains("#")?u:"#"+u);n.ajax({url:t.path("app/getregions/"+o),type:"GET",cache:!0,success:function(n){var i,r,t,f,u;if(n.success){for(i="",r=n.regions,t=0,f=r.length;t<f;t++)u=r[t],i+='<option value="{0}">{1}<\/option>'.format(u.RegionCode,u.RegionName);e.html(i);window.trigger("regionspopulated",e)}}})}});n("[data-address-bind]",r).on("change",function(t,i){var f=n(this),e=f.val(),u=f.data("address-bind"),o=n(u.contains("#")?u:"#"+u),r=o.parents(".form-group").first();e=="US"?i&&i._init?r.hide():r.slideUp("fast"):i&&i._init?r.show():r.slideDown("fast")}).triggerHandler("change",[{_init:!0}]);n('[data-role="Country"]',r).on("change",function(t,i){var f=n(this),e=f.val(),u=n('[data-role="verify"]',r).parents(".row").first();e=="US"?i&&i._init?u.show():u.slideDown("fast"):i&&i._init?u.hide():u.slideUp("fast")}).triggerHandler("change",[{_init:!0}]);n('[data-role="verify"]',r).on("click",function(){var t=n(this),f=n('[data-role="verify"]',r);u.verifyAddress(i)})},getAddress:function(t){var r=n(t),i;return r.length==0?null:(i={},i.$address1=r.find('[data-role="Address1"]'),i.address1=i.$address1.val(),i.$address2=r.find('[data-role="Address2"]'),i.address2=i.$address2.val(),i.$city=r.find('[data-role="City"]'),i.city=i.$city.val(),i.$state=r.find('[data-role="State"]'),i.state=i.$state.val(),i.$zip=r.find('[data-role="Zip"]'),i.zip=i.$zip.val(),i.$country=r.find('[data-role="Country"]'),i.country=i.$country.val(),i)},clearAddress:function(n){var t=u.getAddress(n);t!=null&&(t.$address1.val(""),t.$address2.val(""),t.$city.val(""),t.$zip.val(""))},copyAddress:function(n,t){var i=u.getAddress(t),r,f;if(i!=null&&(r=u.getAddress(n),r!=null))if(i.$address1.val(r.address1),i.$address2.val(r.address2),i.$city.val(r.city),i.$zip.val(r.zip),i.country==r.country)i.$state.val(r.state),i.$country.val(r.country);else{f=function(n){n==i.$state&&(i.$state.val(n.val()),window.off("regionspopulated",f))};window.on("regionspopulated",function(n){f(n)});i.$country.val(r.country).triggerHandler("change")}},verifyAddress:function(i){var f=u.getAddress(i),e=n('[data-role="verify"]',n(i)),s,o;if(f.address1!=""&&f.city!=""&&f.state!=""&&f.zip!=""&&f.country!=""&&f.country=="US"){s={};for(o in f)o.indexOf("$")==-1&&(s[o]=f[o]);r.json({url:t.path("app/verifyaddress"),data:s,beforeSend:function(){e.button("Verifying")},success:function(n){var i="",t;n.IsValid?(i='<span class="text-success verification-status" style="margin-left: 10px;"><i class="fa-check"><\/i> Verified!<\/span>',t=n.VerifiedAddress,f.$address1.val(t.Address1),f.$address2.val(t.Address2),f.$city.val(t.City),f.$state.val(t.State),f.$zip.val(t.Zip),f.$country.val(t.Country)):i='<span class="text-danger verification-status" style="margin-left: 10px;"><i class="fa-warning"><\/i> We were unable to verify your address - try again.<\/span>';e.after(i);setTimeout(function(){e.siblings(".verification-status").fadeOut("fast",function(){e.siblings(".verification-status").remove()})},3e3)},complete:function(){e.button("reset")}})}}};return u});